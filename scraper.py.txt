import os
import requests
from bs4 import BeautifulSoup
from requests.auth import HTTPBasicAuth

def fetch_uscis_news():
    url = "https://www.uscis.gov/newsroom/news-releases"
    response = requests.get(url)
    if response.status_code != 200:
        print(f"Failed to retrieve page, status code: {response.status_code}")
        return []

    soup = BeautifulSoup(response.text, "html.parser")
    news_links = soup.select('.views-row .field-content a[hreflang="en"]')

    news_items = []
    for link in news_links:
        title = link.get_text(strip=True)
        href = link['href']
        full_url = f"https://www.uscis.gov{href}"
        news_items.append({'title': title, 'url': full_url})

    return news_items

def post_to_wordpress(title, url, wp_site, wp_user, wp_password):
    api_url = f"{wp_site}/wp-json/wp/v2/posts"
    post_data = {
        'title': title,
        'content': f'<a href="{url}" target="_blank">{url}</a>',
        'status': 'publish'
    }
    auth = HTTPBasicAuth(wp_user, wp_password)
    response = requests.post(api_url, json=post_data, auth=auth)
    if response.status_code == 201:
        print(f"Posted: {title}")
    else:
        print(f"Failed to post: {title}, Status code: {response.status_code}, Response: {response.text}")

if __name__ == "__main__":
    WP_SITE = os.getenv("WP_SITE_URL")             # 你的 WordPress 網址
    WP_USER = os.getenv("WP_USERNAME")             # WordPress 帳號
    WP_PASSWORD = os.getenv("WP_APP_PASSWORD")     # 應用程式密碼

    if not all([WP_SITE, WP_USER, WP_PASSWORD]):
        print("請先設定環境變數 WP_SITE_URL, WP_USERNAME, WP_APP_PASSWORD")
        exit(1)

    news = fetch_uscis_news()
    for item in news:
        post_to_wordpress(item['title'], item['url'], WP_SITE, WP_USER, WP_PASSWORD)
